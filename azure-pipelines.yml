# Node.js

# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript


pr: none

trigger:
  - master
pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '12.x'
    displayName: 'Install Node.js'
  - script: |
      git config user.email "$(GIT_EMAIL)"
      git config user.name "$(GIT_NAME)"
      git remote set-url origin "https://$(GH_TOKEN)@github.com/rajzik/lumos.git" > /dev/null 2>&1
      git checkout master
    condition: not(contains(variables['Build.SourceVersionMessage'], '[ci skip]'))
    displayName: 'git setup'

  - script: |
      yarn install
      git reset --hard
    condition: not(contains(variables['Build.SourceVersionMessage'], '[ci skip]'))
    displayName: 'yarn install'

  - script: |
      npm config set //registry.npmjs.org/:_authToken=$(NPM_TOKEN)
      yarn run release
    condition: not(contains(variables['Build.SourceVersionMessage'], '[ci skip]'))
    env:
      GH_TOKEN: $(GH_TOKEN)
    displayName: 'yarn release'
